name: AI Platform CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  security-events: write
  actions: read
  id-token: write

env:
  PYTHON_VERSION: "3.13"
  NODE_VERSION: "24"
  IMAGE_NAME: lm-webui

# Cancel in-progress runs on same branch to save resources
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ----------------------------------------
  # STAGE 1: VALIDATE & TEST (Parallel)
  # ----------------------------------------
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install lint tools
        run: pip install ruff mypy

      - name: Ruff lint (blocking)
        run: ruff check backend

      - name: Mypy type check (blocking)
        run: mypy backend --ignore-missing-imports

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        run: cd frontend && npm ci

      - name: TypeScript type check (blocking)
        run: cd frontend && npm run typecheck

  test:
    name: Unit & AI Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install backend dependencies
        run: cd backend && pip install -r requirements.txt pytest pytest-cov

      - name: Run backend unit tests
        run: |
          cd backend
          python -m pytest tests/ -v \
            --cov=app \
            --cov-report=xml \
            --cov-fail-under=60 \   # Enforce minimum 60% coverage
            -x                        # Stop on first failure

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false # Don't fail CI on Codecov outage

      - name: AI smoke test
        run: |
          cd backend
          python -c "
          import sys

          # Test model registry
          from app.services.model_registry import ModelRegistry
          print('✓ ModelRegistry import OK')

          # Test RAG components
          from app.rag.processor import DocumentProcessor
          print('✓ RAG DocumentProcessor import OK')

          # Test all AI routes are registered
          from app.main import app
          routes = [r.path for r in app.routes]
          required = ['/api/chat/completions', '/api/rag', '/api/inference']
          missing = [r for r in required if r not in routes]
          if missing:
              print(f'✗ Missing AI routes: {missing}')
              sys.exit(1)
          print(f'✓ All {len(required)} required AI routes present')

          print('AI smoke test PASSED')
          "

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        run: cd frontend && npm ci

      - name: Run frontend tests
        run: cd frontend && npm test -- --coverage --watchAll=false

      - name: Upload frontend coverage
        uses: codecov/codecov-action@v4
        with:
          directory: frontend/coverage
          flags: frontend
          fail_ci_if_error: false

  # ----------------------------------------
  # STAGE 2: SECURITY SCANNING (Parallel with tests)
  # ----------------------------------------
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies for audit
        run: cd backend && pip install -r requirements.txt pip-audit

      - name: Python dependency audit (CRITICAL only)
        run: |
          cd backend
          pip-audit --severity critical --format json -o pip-audit.json || true
          # Fail on critical CVEs, warn on high
          pip-audit --severity critical

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend deps
        run: cd frontend && npm ci

      - name: npm audit (high+critical only)
        run: cd frontend && npm audit --audit-level=high

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: python, javascript

      - name: CodeQL Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: CodeQL Analysis Results
        uses: github/codeql-action/analyze@v3
        with:
          output: codeql-results.sarif

  # ----------------------------------------
  # STAGE 3: BUILD & CONTAINER SCAN (Depends on lint, test, security)
  # ----------------------------------------
  build:
    name: Build & Container Scan
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install backend deps
        run: cd backend && pip install -r requirements.txt

      - name: Validate OpenAPI contract
        run: |
          cd backend
          python -c "
          from app.main import app
          import json
          schema = app.openapi()
          # Validate required fields exist
          assert 'info' in schema, 'OpenAPI missing info'
          assert 'paths' in schema, 'OpenAPI missing paths'
          print(f'✓ OpenAPI schema valid: {len(schema[\"paths\"])} endpoints')
          "

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha # Use GitHub Actions cache
          cache-to: type=gha,mode=max # Persist cache between runs

      - name: Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:test
          severity: CRITICAL,HIGH
          exit-code: "1" # Fail on CRITICAL/HIGH — enforce this
          format: "sarif"
          output: "trivy-results.sarif"
          skip-files: |
            **/models/**
            **/blobs/**
            **/rerank/**

      - name: Upload Trivy results
        if: always() # Upload even on failure for visibility
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

      # Cache image for deploy job to avoid rebuilding
      - name: Export Docker image
        run: docker save ${{ env.IMAGE_NAME }}:test | gzip > image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar.gz
          retention-days: 1

  # ----------------------------------------
  # STAGE 4: RUNTIME VERIFICATION (Depends on build)
  # ----------------------------------------
  deploy-verify:
    name: Runtime Verification
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load < image.tar.gz # Reuse built image, don't rebuild

      - name: Run container health verification
        run: |
          docker run -d -p 8000:8000 --name app_test \
            --health-cmd="curl -f http://localhost:8000/health || exit 1" \
            --health-interval=5s \
            --health-retries=5 \
            ${{ env.IMAGE_NAME }}:test

          # Wait for healthy status instead of fixed sleep
          echo "Waiting for container to be healthy..."
          timeout 60 bash -c 'until [ "$(docker inspect --format="{{.State.Health.Status}}" app_test)" = "healthy" ]; do sleep 2; done'
          echo "Container is healthy"

          # Core health endpoints
          curl --fail http://localhost:8000/health
          curl --fail http://localhost:8000/api/health

          # AI endpoint availability (auth expected — 401/403 is OK, 500 is not)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/api/chat/completions \
            -H "Content-Type: application/json" \
            -d '{"messages":[{"role":"user","content":"test"}]}')
          if [ "$STATUS" = "500" ] || [ "$STATUS" = "000" ]; then
            echo "✗ AI endpoint returned $STATUS — unexpected server error"
            exit 1
          fi
          echo "✓ AI endpoint responded with $STATUS (auth expected)"

      - name: Docker Compose integration test
        run: |
          docker-compose up -d

          # Wait for compose stack to be ready
          timeout 60 bash -c 'until curl -sf http://localhost:7070/health; do sleep 3; done'
          echo "✓ Compose stack healthy"

          docker-compose ps
          docker-compose logs --tail=30 backend

      - name: Cleanup
        if: always()
        run: |
          docker rm -f app_test || true
          docker-compose down --volumes
